Macro功能设计
===

# 目标
Macro的主要目标是为了解决运维和开发人员在配置代理和Web服务器时遇到的一些问题。

> 运维人员经常临时性修改nginx的配置之后就将配置放在服务器的目录下没有进行相关配置管理。
> 多个服务器作为Nginx镜像服务器同步相关内容
> 监控报警
> 动态Upstream
> 配置文件可编程
> 灰度发布

## 为什么重复造轮子
市场上对应的替代产品很多，如`kong`, `traefik`都可以作为可编程的代理服务器管理上下游Web应用。但是本人通过使用一段时间后发现这些开源软件和我们的需求还是有一定差别。运维人员使用nginx除了做代理以外主要是把它当做一个Web服务器使用。尤其是Web2.0前后端分离的情况，前端代码一般托管在nginx上。后端直接通过nginx代理访问Upstream。有的时候还需要直接修改nginx配置截断HTTP请求做一些临时处理。举个例子:

我们的开发人员开发了一个前端JS脚本，负责加载一个Mp4播放器。突然线上出现一个重大的BUG，要求开发人员必须在短时间内解决。这个时候走DevOps流程有可能会比较慢。为了加快进度，开发人员临时作了一个新的脚本放到nginx要求运维人员替换一下。运维人员可能就在nginx配置上直接将对应js的脚本给路由到一个新的文件上直接调试。

还有个例子，运维人员在使用某些第三方服务的时候需要在网站上添加某个验证文件。这个验证文件没有就使用一次。为了达到这个目的还要再走遍DevOps流程没准就得不偿失了。因此运维人员会直接修改nginx配置文件，添加一条配置去解决。
```nginx
location /7odzevR7mu.txt  {
    root /data/openresty/nginx/html/yanzheng;
}
```
有的后端服务器宕机了。要显示一下维护页面，没准这个页面就直接配置在了nginx服务器上。

服务器带宽不够用了要301分流到异地的机房。运维人员会修改nginx配置直接重定向到新的网站，或者通过lua脚本根据流量判断进行分流。

以上的这些需求在使用市面上的开源软件的时候基本上就没有相关配置服务。如果直接使用nginx没有有效的运维配置管理手段又有可能造成配置管理失控。

因此，设计Macro的目的就是为了要解决这些问题。通过可视化工具对线上的Nginx服务器进行配置管理，同时将相关配置版本用git管理起来。通过结构化的数据记录Nginx的配置，通过git管理所有配置文件，包括站点静态文件版本，进而可以实现Snapshot，版本回退，灰度发布等相关功能。

同时为了帮助前端开发人员快速构建生产Web应用，定义一个类似Helm协议的Web应用配置文件，和静态站点文件一起打包上传到Macro上会根据这些配置文件形成初始化的Nginx配置。进而与DevOps流程快速集成。
## 核心概念
### 运行实例NgInst(NginxInstance)
代表一个Nginx的运行实例，提供运行，停止，测试配置，重新加载配置，以及一些Global配置。
### 站点(Site)
对应Nginx的`server`配置，包括域名，端口，证书，静态文件等配置。
### 路由(Route)
对应Nginx中的`location`配置.包括路由到Upstream, 路由静态文件,重定向等操作。
### 上游服务器(Upstream)
对应Nginx的`upstream`配置，支持动态配置。以及健康检查

## 组件
### Macro Admin
提供管理接口，对Nginx实例进行管理，以及站点路由相关管理。
### Macro Server
运行在服务器上，直接管理本地的Nginx包括启停与相关版本操作
### Macro Cli
提供DevOps相关功能，与本地的Server通讯类似Docker Cli与Docker Daemon的关系
### .tgz文件
静态文件与站点初始化配置(.Macro)打包生成的zip文件，其中.Macro文件通过json或者yaml的形式描述站点信息以及站点对应的路由，和初始化upstream信息。
## 功能列表
### Macro Admin
> 站点管理
>> 上传
>> 修改站点信息
>> 查询站点与列表
> 路由管理
>> 增加删除路由
>> 修改路由
>> 查询路由与列表
> 证书管理
> Upstream管理
>> 新增，删除
>> 更改Upstream中的Server信息
> 版本管理
>> 实例整体创建Snapshot
>> 针对站点创建版本，列出版本信息与列表
>> 对比版本
>> 回退到指定的版本
> 实例管理
>> 列出所有Nginx实例
>> 增删改实例MetaData
>> 启停重启配置实例
> 可管理Nginx以及resty和tengine等基于nginx开发的Web服务器
> Nginx配置文件可动态修改
> 所有配置可进行版本管理
> 动态Upstream
> 远程管理多个Nginx实例
> 以站点为单位通过路由管理配置
> 以命令行的形式提供DevOps相关功能，包括Web镜像制作，站点路由相关规则配置，以及打包发布到Macro上。
> 以命令行的形式实现快速搭建Nginx服务器，提供Nginx配置修改和站点，路由规则配置。
> 提供基于站点的Promethues监控接口
> 站点日志集中处理